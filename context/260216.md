# ğŸ“‚ Project Handoff: Quincunx & Orchid

**Project Status:** Active / Architectural Design Phase
**Primary Language:** Elixir
**Context:** Music Generation (AI/DSP), Workflow Orchestration, Incremental Rendering.

## 1. ç”¨æˆ·ç”»åƒä¸åå¥½ (User Context)
*   **æŠ€æœ¯æ ˆ:** Elixir å¼€å‘è€… (Nx, OTP, Metaprogramming), äº†è§£ ML/DSP æ¦‚å¿µã€‚
*   **å½“å‰çŠ¶æ€:** å¯¹è¿‡åº¦ç»†èŠ‚æ„Ÿåˆ° Overwhelmedï¼Œç›®å‰å¸Œæœ›èšç„¦åœ¨ **Scope, Spec, å’Œ High-level æ¶æ„** ä¸Šï¼Œæš‚ç¼“å…·ä½“ä»£ç å®ç°ã€‚
*   **æ²Ÿé€šåå¥½:** ä¸­æ–‡äº¤æµã€‚å–œæ¬¢å…ˆå®šæ¶æ„å†å¡«è‚‰ã€‚
*   **æ ¸å¿ƒåŠ¨æœº:** æ„å»ºä¸€ä¸ªåŸºäº Elixir çš„éŸ³ä¹ç”Ÿæˆå·¥ä½œæµå¼•æ“ï¼ˆåŸºäº Orchidï¼‰ï¼Œå¹¶åœ¨å…¶ä¸Šæ„å»ºåº”ç”¨å±‚ï¼ˆQuincunxï¼‰ï¼Œæ”¯æŒåŸºäº **ä¹å¥ (Phase/Bar)** çš„å¢é‡ç”Ÿæˆã€ç¼–è¾‘å’Œæ··éŸ³ã€‚

## 2. æ ¸å¿ƒé¡¹ç›®å®šä¹‰ (Definitions)

### ğŸŒ¸ **Orchid (The Engine)**
ä¸€ä¸ªæ— çŠ¶æ€ (Stateless) çš„å·¥ä½œæµç¼–æ’åº“ã€‚
*   **Core Concepts:** `Recipe` (é™æ€å›¾), `Step`, `Pipeline`, `Hook`.
*   **Design Phil:** ç±»ä¼¼äº `Nx.Serving` æˆ– `Oban` çš„æµæ°´çº¿ï¼Œæ”¯æŒ Hook æœºåˆ¶æ³¨å…¥é€»è¾‘ã€‚

### ğŸ² **Quincunx (The Application)**
æ„å»ºåœ¨ Orchid ä¹‹ä¸Šçš„åº”ç”¨å®ä½“ï¼ˆåŸ QyCoreï¼‰ã€‚
*   **è´£ä»»:** ç®¡ç†çŠ¶æ€ã€ç”¨æˆ·äº¤äº’ã€å†å²è®°å½•ã€ç¼“å­˜ç­–ç•¥ã€‚
*   **æ•°æ®åˆ†ç±» (Persistence Strategy):**
    1.  **User Input:** åˆå§‹å‚æ•° + ç”¨æˆ·åç»­çš„å¾®è°ƒ (Tweaks)ã€‚
    2.  **Scheduling Graph:** åŸºäº Recipe çš„å…·ä½“æ‰§è¡Œå›¾ï¼ˆåŒ…å«ç”¨æˆ·ä¿®æ”¹åçš„ä¾èµ–å…³ç³»ï¼‰ã€‚
    3.  **Re-parameters (Artifacts):** æ¨¡å‹ç”Ÿæˆçš„å¤§ä½“ç§¯ä¸­é—´äº§ç‰©ï¼ˆLatents, Spectrograms, Audioï¼‰ã€‚**è¿™æ˜¯å†…å­˜ç®¡ç†çš„ç—›ç‚¹ã€‚**

## 3. å·²è®¨è®ºçš„å…³é”®æ¶æ„ç‚¹ (Architecture Highlights)

### A. å¢é‡ç”Ÿæˆä¸ä¾èµ–ç®¡ç† (Incremental Generation)
*   **é€»è¾‘:** ä¿®æ”¹å‰é¢çš„ä¹å¥ï¼ˆParam Aï¼‰ï¼Œä¼šå¯¼è‡´è¯¥ä¹å¥é‡æ–°æ¸²æŸ“ï¼Œå¹¶è§¦å‘åç»­ä¾èµ–è¯¥ä¹å¥çš„æ··éŸ³/Mastering é‡æ–°è®¡ç®—ã€‚æœªå—å½±å“çš„ä¸­é—´ä¹å¥ï¼ˆParam Bï¼‰åº”ç›´æ¥å‘½ä¸­ç¼“å­˜ã€‚
*   **ç²’åº¦:** ä¹å¥ (Phrase) / å°èŠ‚ (Bar) çº§åˆ«ï¼Œè€Œéç®€å•çš„å•éŸ³èŠ‚æˆ–å…¨æ›²ã€‚

### B. "è„±æ°´"ç­–ç•¥ (Dehydration Strategy)
ä¸ºäº†è§£å†³å¤§å¯¹è±¡åœ¨ Elixir è¿›ç¨‹é—´ä¼ é€’æˆ–å­˜å‚¨æ—¶çš„å¼€é”€ï¼Œå¼•å…¥äº† Dehydration æœºåˆ¶ã€‚
*   **Mechanism:** å°†å¤§ä½“ç§¯æ•°æ®ï¼ˆTensors, Binariesï¼‰å†™å…¥å­˜å‚¨ï¼ˆETS/Diskï¼‰ï¼Œä»…åœ¨ Workflow ä¸­ä¼ é€’è½»é‡çº§çš„ Reference `{:ref, repo, key}`ã€‚
*   **Current Code:** ç”¨æˆ·å·²æä¾›äº† `Orchid.RunnerHooks.ParamsDehydration` å’Œ `Greenhouse.Storage` (ETS based) çš„å®ç°åŸå‹ã€‚
*   **Threshold:** å¤§äºé˜ˆå€¼ï¼ˆå¦‚ 1KBï¼‰çš„æ•°æ®æ‰è„±æ°´ã€‚

### C. ç¼“å­˜é”®è®¾è®¡ (Caching & Hashing)
*   **Raw Hash:**ç›®å‰ä½¿ç”¨ `:erlang.phash2`ã€‚
*   **Semantic Hash (TODO):** è®¡åˆ’æ ¹æ®æ•°æ®ç±»å‹ï¼ˆ`Orchid.Param` typeï¼‰é‡‡ç”¨ä¸åŒçš„æ‘˜è¦ç®—æ³•ã€‚ä¾‹å¦‚ï¼š
    *   `MelSpectrum`: éœ€è¦ä¸€ç§èƒ½å®¹å¿å¾®å°æµ®ç‚¹è¯¯å·®çš„æ‘˜è¦æˆ–åŸºäºå†…å®¹çš„ Hashã€‚
    *   `Pitch`: å¦ä¸€å¥—ç­–ç•¥ã€‚
    *   *Goal:* æ¦‚è¦ + Hash => ç¼“å­˜é”®ã€‚

## 4. é—ç•™é—®é¢˜ä¸å½“å‰æŒ‘æˆ˜ (Pending Issues & The "Ask")

<details open>
<summary><b>ğŸš¨ é‡ç‚¹ï¼šè¿™æ˜¯ä½ éœ€è¦ç«‹å³å›ç­”çš„é—®é¢˜</b></summary>

ç”¨æˆ·åœ¨å¯¹è¯ç»“æŸå‰æå‡ºäº†ä¸¤ä¸ªæ ¸å¿ƒçš„æŠ€æœ¯/æ¶æ„ç–‘è™‘ï¼Œéœ€è¦ä½ ï¼ˆæ–°çš„ AIï¼‰åœ¨æ¥æ‰‹åä¼˜å…ˆè§£ç­”ï¼š

### Q1: Dehydration çš„æ€§èƒ½å¼€é”€ (Performance Overhead)
> *"é€šè¿‡ `Orchid.RunnerHooks.ParamsDehydration` æ˜¯ä¸æ˜¯ä¹Ÿä¼šæœ‰é‚£äº›æ€§èƒ½å¼€é”€å•Šï¼Ÿæˆ‘è¿™ä¹ˆè®¾è®¡çš„ç›®çš„æ˜¯å®³æ€•å¾ˆå¤šæ•°æ®çš„ struct/map scaffold ä¼šå¾ˆå¤§ï¼Œæ¥å› copy å¯èƒ½å ç”¨æ¯”è¾ƒå¤šã€‚"*

*   **Context:** ç”¨æˆ·æ‹…å¿ƒè™½ç„¶ Payload è„±æ°´äº†ï¼Œä½† Param ç»“æ„ä½“æœ¬èº«çš„éå†ã€ETS çš„ `insert/lookup` (è¿™æ¶‰åŠåˆ°æ•°æ®ä» Process Heap åˆ° ETS Table çš„å¤åˆ¶) ä¾ç„¶æœ‰å¼€é”€ã€‚
*   **Need:** åˆ†æ ETS copy overhead vs Process Message Passing overheadã€‚è¯„ä¼°ç›®å‰çš„ Dehydration æ˜¯æ­£ä¼˜åŒ–è¿˜æ˜¯è´Ÿä¼˜åŒ–ã€‚

### Q2: `opts` çš„ä¸€è‡´æ€§ä¸ç¼“å­˜æ±¡æŸ“ (Opts Consistency)
> *"åœ¨ç¼“å­˜æ—¶æ€ä¹ˆç¡®ä¿ç»Ÿä¸€å‘¢ï¼Ÿâ€¦â€¦åªæœ‰ä¼šè¢«ä¸¢åˆ° Orchid.run é‡Œé‚£ä¸ª Recipe ä¸­ steps çš„ opts æ‰å±äºã€Œä¸šåŠ¡ã€ï¼Œå…¶ä»–çš„ dynamic opts å±äºè¿è¡Œæ—¶ä¸Šä¸‹æ–‡ã€‚"*

*   **Problem:** `opts` åˆ—è¡¨é‡Œæ··æ‚äº†â€œå½±å“ç”Ÿæˆçš„å‚æ•°â€ (Business Logic) å’Œ â€œè¿è¡Œæ—¶é…ç½®â€ (Telemetry ID, Runtime Flags)ã€‚å¦‚æœç›´æ¥ Hash æ•´ä¸ª `opts`ï¼Œä¼šå¯¼è‡´ç¼“å­˜å‘½ä¸­ç‡æä½ï¼ˆå› ä¸º Runtime Flags æ¯æ¬¡éƒ½å˜ï¼‰ã€‚
*   **Proposed Idea:** éœ€è¦ä¸€ç§è§„èŒƒï¼ˆSpec/Allowlistï¼‰æ¥æ˜ç¡®å“ªäº› `opts` å‚ä¸ Hash è®¡ç®—ã€‚
</details>

## 5. Quincunx æ“ä½œæµ (Workflow Context)

ç”¨æˆ·æè¿°äº† Quincunx çš„äº”ç§æ ¸å¿ƒæ“ä½œï¼Œè¿™åº”å½“ä½œä¸ºè®¾è®¡ `Orchid.Session` æˆ– `Executor` çš„åŸºç¡€ï¼š
1.  **Create:** New Phase based on Recipe.
2.  **Modify:** Change inputs/middle params.
3.  **Execute:** Generation tasks (Interruptible, obtaining recurring params).
4.  **Backup:** Snapshot history (Graph + User Input).
5.  **Filter/GC:** æ¸…ç†æ— ç”¨çš„ Re-parameters (Artifacts) é˜²æ­¢ OOMï¼Œåªä¿ç•™ Outputsã€‚

## 6. ä¸‹ä¸€æ­¥å»ºè®® (Next Steps)

1.  **è§£ç­” Q1 & Q2:**
    *   åˆ†æ Dehydration åœ¨ Elixir/OTP æ¨¡å‹ä¸‹çš„çœŸå®çš„å†…å­˜/CPU æƒè¡¡ã€‚
    *   è®¾è®¡ä¸€ä¸ªæœºåˆ¶ï¼ˆå¯èƒ½æ˜¯ Recipe ä¸­çš„ `definition`ï¼‰æ¥å£°æ˜å“ªäº› Opts æ˜¯ "Cache Significant" çš„ã€‚

2.  **å®Œå–„ `Executor` è®¾è®¡:**
    *   åŸºäºç”¨æˆ·æä¾›çš„ Quincunx éœ€æ±‚ï¼Œè®¾è®¡ Orchid å¤–éƒ¨çš„è¿™ä¸ªâ€œæœ‰çŠ¶æ€æ‰§è¡Œå™¨â€ã€‚å®ƒå¦‚ä½•æŒæœ‰ç”± Dehydration è¿”å›çš„ Reference mapï¼Ÿå¦‚ä½•è¿›è¡Œ GCï¼Ÿ

3.  **è¯­ä¹‰åŒ– Hashing:**
    *   è®¨è®ºé’ˆå¯¹ Nx Tensor æˆ– Audio chunk çš„å…·ä½“ Hash ç­–ç•¥ã€‚

---

**To the next AI:** The user is sophisticated and prefers discussing architectural patterns over boilerplate code. Good luck building Quincunx! ğŸš€